## C++ 编译器工作原理

源码要运行，必须转成二进制的机器码。这是编译器的任务。下面简单描述一下编译器的几大过程：
- 配置。工作之前需要知道当前的系统环境，标准库的为之、软件的安装位置、需要安装的组件等等；因为计算机操作系统环境的不同，需要在编译之前指定编译参数，来区分不同环境生成不同的机器码，编译器通过灵活的指定编译参数来适应环境；
- 确定标准库和头文件的位置。我们编写的代码，肯定需要用到标准库函数和头文件，配置文件中会给出若干配置目录，按顺序可以找到这些文件
- 确定依赖关系。当项目大了之后，会存在文件依赖，编译器保证了：1) 只有在B文件编译完后才开始编译A；2) 当B文件发生变化时，A会被重新编译；Makefile文件决定了依赖关系
- 头文件预编译。编译器在编译源码之前，先编译头文件；
- 预处理。预编译完成后，编译器就开始替换头文件和宏；也会去掉注释；
- 编译。一般会把源码转成汇编码，再转成机器码；这样会产生一个 object file
- 连接（linking）。object file 不能运行，需要转成可执行文件。现在就需要把外部函数的代码，添加到可执行文件中；通过拷贝，将外部函数库添加到可执行文件的方式，叫做静态链接；从头文件预编译开始到这一步是 make 干的事情；
- 安装。将编译生成的可执行文件，安装到机器上的指定目录；
操作系统连接。用来注册到系统中，比如快捷方式；make install 就会干安装和系统连接的事情。
生成安装包。
- 动态链接。在编译阶段，我们可以选在外部函数库连接的方式，动态 or 静态；动态连接是外部函数库不进入安装包，只在运行时动态引用。

以上这些是编译器的一般过程。

### 更加一般性的过程

![bianyiyuanli](https://github.com/shniu/resources/raw/master/images/cpp-bianyiyl.png)

##### 关于预处理

C++编译器提供的预处理功能主要有文件包含、宏替换、条件编译等；

1. 头文件查找的两种形式：
```
#include <...>   // 直接在系统目录中去找某些头文件  
#include "..."    // 先去源文件所在文件夹找，找不到再去系统目录找
include 的系统目录一般为：
  /usr/include
  /usr/local/include
  /usr/lib/gcc-lib/i386-linux/2.95.2/include
```
2. 宏替换。替换掉代码中所有使用宏的代码
3. 条件编译。条件编译主要是进行编译时进行有选择的挑选，注释掉一些指定的代码，以达到多个版本控制、防止对文件重复包含的功能

##### 关于编译
编译过程的步骤是词法分析、语法分析、语言、语义分析；在这些步骤进行完以后，会生成一个明确的低级的类机器语言的中间表示。可以对中间表示进行优化，生成更好的目标代码

##### 关于汇编
生成目标文件，目标文件中存放的是和源程序等效的目标机器语言代码。目标文件至少有：代码段和数据段。

##### 关于连接
主要是将在一个文件中引用的符号同该符号在另外一个文件中的定义连接起来，使得所有的这些目标文件成为一个能够按操作系统装入执行的统一整体。要注意静态链接库中不能再包含其他的动态链接库或者静态库，而在动态链接库中还可以再包含其他的动态或静态链接库。

静态链接库
![静态链接库](https://github.com/shniu/resources/raw/master/images/cpp-static-lib.png)

动态链接库
![动态链接库](https://github.com/shniu/resources/raw/master/images/cpp-dynamic-lib.png)

### Ref

1. [编译器的工作过程](http://www.ruanyifeng.com/blog/2014/11/compiler.html)   简单明了的讲解了编译器干的事情，将编译过程分成了 11 步进行讲解
2. [C++编译器工作原理](https://github.com/xuelangZF/CS_Offer/blob/master/C%2B%2B/Compiler.md)  描述的更加详细一些，这个过程更加符合 c++ 程序的编译过程，可以进行深入了解
3. [帮助C/C++程序员彻底了解连接器](http://blog.jobbole.com/96225/)
4. [高级语言的编译：连接及装载过程介绍](https://tech.meituan.com/linker.html)